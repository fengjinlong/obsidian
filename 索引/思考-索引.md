### ç®€å•çš„diff

1.  å½“æ–°æ—§èŠ‚ç‚¹çš„`å­èŠ‚ç‚¹` éƒ½æ˜¯æ•°ç»„èŠ‚ç‚¹ï¼Œä¸ºäº†ä»¥æœ€å°æ€§èƒ½å¼€é”€å®Œæˆæ›´æ–°ï¼Œæ¯”è¾ƒä¸¤ç»„å­èŠ‚ç‚¹ï¼Œç”¨äºæ¯”è¾ƒçš„ç®—æ³•å°±æ˜¯Diff ç®—æ³•ã€‚
2.  å‡è®¾æ–°æ—§èŠ‚ç‚¹å¦‚ä¸‹

```JavaScript
const oldVnode = {
  type: "div",
  children: [
    { type: "p", children: "1" },
    { type: "p", children: "2" },
    { type: "p", children: "3" },
  ],
};

const newVnode = {
  type: "div",
  children: [
    { type: "p", children: "4" },
    { type: "p", children: "5" },
    { type: "p", children: "6" },
  ],
};
```

ç›´æ¥æ›´æ–°p æ ‡ç­¾å¯¹åº”çš„æ–‡æœ¬èŠ‚ç‚¹ï¼Œåªè¿›è¡Œ3æ¬¡domæ“ä½œ

![](image.png)

```JavaScript
function patch(n1, n2, container) {
  if (n2.children === "string") {
  } else if (Array.isArray(n2.children)) {
    const oldChildren = n1.children;
    const newChildren = n2.children;
    for (let i = 0; i < oldChildren.length; i++) {
      **patch(oldChildren[i], newChildren[i]);**
    }
  } else {
  }
}
```

3.  å­˜åœ¨çš„é—®é¢˜å°±æ˜¯åŠ å…¥æ–°æ—§èŠ‚ç‚¹çš„é•¿åº¦ä¸ä¸€æ ·ï¼Œä¸Šé¢é€»è¾‘å°±ä¸é€‚ç”¨äº†ã€‚

-   å¦‚æœæ–°çš„é•¿ï¼Œå°†å¤šçš„æ–°çš„èŠ‚ç‚¹æŒ‚è½½ã€‚
-   å¦‚æœæ—§çš„é•¿ï¼Œå°†å¤šçš„æ—§çš„èŠ‚ç‚¹å¸è½½ã€‚

![](image%20(1).png)


```JavaScript
function patch(n1, n2, container) {
  if (n2.children === "string") {
  } else if (Array.isArray(n2.children)) {
    const oldChildren = n1.children;
    const newChildren = n2.children;

    const oldLen = oldChildren.length;
    const newLen = newChildren.length;

    const commonLength = Math.min(oldLen, newLen);

    for (let i = 0; i < commonLength; i++) {
      patch(oldChildren[i], newChildren[i]);
    }
    if (newLen > oldLen) {
      // æŒ‚è½½
      for (let i = commonLength; i < newLen; i++) {
        patch(null, newChildren[i]);
      }
    } else if (newLen < oldLen) {
      // å¸è½½
      for (let i = commonLength; i < oldLen; i++) {
        unmount(oldChildren[i]);
      }
    }
  } else {
  }
}
```

4.  å¦‚æœæ–°æ—§èŠ‚ç‚¹å¦‚æœåªæ˜¯é¡ºåºä¸åŒï¼Œé‚£ä¹ˆåªéœ€è¦ç§»åŠ¨èŠ‚ç‚¹ä¾¿å®Œæˆäº†æ›´æ–°

![](image%201.png)

æ‰€ä»¥æ–°æ—§ä¸¤ç»„èŠ‚ç‚¹åªè¦ç¡®å®šå­˜åœ¨å¯å¤ç”¨çš„èŠ‚ç‚¹ã€‚

```JavaScript
const oldChildren = {
  type: "p",
  key: 1,
  children: "text 1",
};

const newChildren = {
  type: "p",
  key: 1,
  children: "text 2",
};
```

åªè¦èŠ‚ç‚¹çš„type ,key ç›¸åŒï¼Œé‚£å°±æ˜¯ç›¸åŒçš„èŠ‚ç‚¹ï¼Œå°±å¯ä»¥è¿›è¡Œå¤ç”¨dom å…ƒç´ ï¼Œå³é€šè¿‡ç§»åŠ¨æ“ä½œå®Œæˆæ›´æ–°ã€‚ä½†ä»ç„¶éœ€è¦å¯¹ä¸¤ä¸ªè™šæ‹Ÿè¿›è¡Œæ‰“è¡¥æ“ä½œï¼Œå› ä¸ºæ–‡æœ¬èŠ‚ç‚¹å·²ç»æ”¹å˜ã€‚1 å¤ç”¨ 2 ç§»åŠ¨

å¤ç”¨ç›¸åŒdom çš„é€»è¾‘

```JavaScript
function patch(n1, n2, container) {
  if (n2.children === "string") {
  } else if (Array.isArray(n2.children)) {
    const oldChildren = n1.children;
    const newChildren = n2.children;

    const oldLen = oldChildren.length;
    const newLen = newChildren.length;
    for (let i = 0; i < newLen; i++) {
      const newVNode = newChildren[i];
      for (let j = 0; j < oldLen; j++) {
        const oldVNode = oldChildren[j];

        if (newVNode.key === oldVNode.key) {
          patch(oldVNode, newVNode);
          break;
        }
      }
    }
  } else {
  }
}
```

ç§»åŠ¨ç›¸åŒ dom çš„é€»è¾‘

-   ä¸éœ€è¦ç§»åŠ¨çš„ğŸŒ°

![](Pasted%20image%2020220314144916.png)

æ–°æ—§ä¸¤ç»„èŠ‚ç‚¹çš„é¡ºåºä¸å˜æ—¶ï¼Œä¸éœ€è¦ç§»åŠ¨ã€‚

-   ç‰¹ç‚¹
    1.  ç¬¬ä¸€æ­¥ï¼šå–æ–°èŠ‚ç‚¹ä¸­çš„ p-1,å®ƒçš„key æ˜¯1ï¼Œåœ¨æ—§èŠ‚ç‚¹ä¸­æ‰¾åˆ°ç›¸åŒkeyçš„å¯å¤ç”¨èŠ‚ç‚¹ï¼Œèƒ½å¤Ÿæ‰¾åˆ°ï¼Œè¯¥æ–°èŠ‚ç‚¹å¯¹åº”çš„æ—§èŠ‚ç‚¹çš„ç´¢å¼•æ˜¯0
    2.  ç¬¬äºŒæ­¥ï¼šå–æ–°èŠ‚ç‚¹ä¸­çš„ p-2,å®ƒçš„key æ˜¯2ï¼Œåœ¨æ—§èŠ‚ç‚¹ä¸­æ‰¾åˆ°ç›¸åŒkeyçš„å¯å¤ç”¨èŠ‚ç‚¹ï¼Œèƒ½å¤Ÿæ‰¾åˆ°ï¼Œè¯¥æ–°èŠ‚ç‚¹å¯¹åº”çš„æ—§èŠ‚ç‚¹çš„ç´¢å¼•æ˜¯1
    3.  ç¬¬ä¸‰æ­¥ï¼šå–æ–°èŠ‚ç‚¹ä¸­çš„ p-3,å®ƒçš„key æ˜¯3ï¼Œåœ¨æ—§èŠ‚ç‚¹ä¸­æ‰¾åˆ°ç›¸åŒkeyçš„å¯å¤ç”¨èŠ‚ç‚¹ï¼Œèƒ½å¤Ÿæ‰¾åˆ°ï¼Œè¯¥æ–°èŠ‚ç‚¹å¯¹åº”çš„æ—§èŠ‚ç‚¹çš„ç´¢å¼•æ˜¯2
    4.  è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæ¯æ¬¡æ‰¾åˆ°å¯å¤ç”¨èŠ‚ç‚¹æ—¶ï¼Œéƒ½ä¼šè®°å½•è¯¥å¯å¤ç”¨èŠ‚ç‚¹åœ¨æ—§çš„ä¸€ç»„èŠ‚ç‚¹ä¸­çš„ä½ç½®ç´¢å¼•ï¼Œå¯ä»¥å¾—åˆ°ä¸€ä¸ªé€’å¢åºåˆ—ã€‚0 1 2ã€‚è¿™ç§æƒ…å†µä¸éœ€è¦ç§»åŠ¨ã€‚

éœ€è¦ç§»åŠ¨çš„ğŸŒ°

![](Pasted%20image%2020220314144807.png)

-   ç‰¹ç‚¹
    1.  ç¬¬ä¸€æ­¥ï¼šå–æ–°èŠ‚ç‚¹ä¸­çš„ p-3,å®ƒçš„key æ˜¯3ï¼Œåœ¨æ—§èŠ‚ç‚¹ä¸­æ‰¾åˆ°ç›¸åŒkeyçš„å¯å¤ç”¨èŠ‚ç‚¹ï¼Œèƒ½å¤Ÿæ‰¾åˆ°ï¼Œè¯¥æ–°èŠ‚ç‚¹å¯¹åº”çš„æ—§èŠ‚ç‚¹çš„ç´¢å¼•æ˜¯2
        
    2.  ç¬¬äºŒæ­¥ï¼šå–æ–°èŠ‚ç‚¹ä¸­çš„ p-1,å®ƒçš„key æ˜¯1ï¼Œåœ¨æ—§èŠ‚ç‚¹ä¸­æ‰¾åˆ°ç›¸åŒkeyçš„å¯å¤ç”¨èŠ‚ç‚¹ï¼Œèƒ½å¤Ÿæ‰¾åˆ°ï¼Œè¯¥æ–°èŠ‚ç‚¹å¯¹åº”çš„æ—§èŠ‚ç‚¹çš„ç´¢å¼•æ˜¯0ã€‚
        
        åˆ°äº†è¿™ä¸€æ­¥æˆ‘ä»¬å‘ç°ï¼Œç´¢å¼•å€¼é€’å¢åºåˆ—è¢«æ‰“ç ´äº†ã€‚èŠ‚ç‚¹p-1 åœ¨æ—§çš„children çš„ç´¢å¼•æ˜¯0ï¼Œå®ƒå°äºèŠ‚ç‚¹p-3åœ¨æ—§children ä¸­çš„ç´¢å¼•2ã€‚`è¯´æ˜èŠ‚ç‚¹p-1åœ¨æ—§çš„childrenä¸­æ’åœ¨èŠ‚ç‚¹p-3å‰é¢ï¼Œä½†åœ¨æ–°çš„childrenä¸­ï¼Œå®ƒåœ¨p-3çš„åé¢ã€‚æ‰€ä»¥ï¼Œp-1å¯¹åº”çš„çœŸå®doméœ€è¦ç§»åŠ¨ã€‚`
        
    3.  ç¬¬ä¸‰æ­¥ï¼šå–æ–°èŠ‚ç‚¹ä¸­çš„ p-2,å®ƒçš„key æ˜¯2ï¼Œåœ¨æ—§èŠ‚ç‚¹ä¸­æ‰¾åˆ°ç›¸åŒkeyçš„å¯å¤ç”¨èŠ‚ç‚¹ï¼Œèƒ½å¤Ÿæ‰¾åˆ°ï¼Œè¯¥æ–°èŠ‚ç‚¹å¯¹åº”çš„æ—§èŠ‚ç‚¹çš„ç´¢å¼•æ˜¯1ã€‚
        
        èŠ‚ç‚¹p-2 åœ¨æ—§çš„children çš„ç´¢å¼•æ˜¯1ï¼Œå®ƒå°äºèŠ‚ç‚¹p-3åœ¨æ—§children ä¸­çš„ç´¢å¼•2ã€‚`è¯´æ˜èŠ‚ç‚¹p-2åœ¨æ—§çš„childrenä¸­æ’åœ¨p-3çš„å‰é¢ï¼Œä½†åœ¨æ–°çš„childrenä¸­æ’åœ¨p-3çš„åé¢ã€‚æ‰€ä»¥ p-2 å¯¹åº”çš„çœŸå®doméœ€è¦ç§»åŠ¨ã€‚`
        
    4.  ç­‰åˆ° 2 0 1 çš„åºåˆ—ï¼Œä¸ç¬¦åˆé€’å¢åºåˆ—ã€‚
        
-   p-3 åœ¨æ—§çš„childrençš„ç´¢å¼•å®šä¹‰ä¸ºï¼š`åœ¨æ—§çš„children ä¸­æ‰¾åˆ°å…·æœ‰ç›¸åŒkeyå€¼èŠ‚ç‚¹çš„è¿‡ç¨‹ä¸­ï¼Œé‡åˆ°æœ€å¤§çš„ç´¢å¼•å€¼`ï¼Œåœ¨åç»­çš„æŸ¥æ‰¾ä¸­ï¼Œå­˜åœ¨æ¯”å½“å‰é‡åˆ°çš„æœ€å¤§çš„ç´¢å¼•å€¼è¦å°çš„èŠ‚ç‚¹ï¼Œå°±æ„å‘³è¯¥èŠ‚ç‚¹éœ€è¦ç§»åŠ¨ã€‚ï¼ˆæ—§çš„ç´¢å¼•è‚¯å®šæ˜¯é€’å¢çš„ï¼Œæ–°çš„èŠ‚ç‚¹å¯¹åº”çš„ç´¢å¼•å¦‚æœä¸æ˜¯é€’å¢ï¼Œé‚£ä¹ˆä¹…éœ€è¦ç§»åŠ¨æ­¤èŠ‚ç‚¹ï¼‰
```js
function patch(n1, n2, container) {
  if (n2.children === "string") {
  } else if (Array.isArray(n2.children)) {
    const oldChildren = n1.children;
    const newChildren = n2.children;

    const oldLen = oldChildren.length;
    const newLen = newChildren.length;
    const lastIndex = 0;
    for (let i = 0; i < newLen; i++) {
      const newVNode = newChildren[i];
      for (let j = 0; j < oldLen; j++) {
        const oldVNode = oldChildren[j];

        if (newVNode.key === oldVNode.key) {
          patch(oldVNode, newVNode);
          if (lastIndex > j) {
            // å½“å‰çš„æ–°èŠ‚ç‚¹æ‰¾åˆ°çš„å¯¹åº”çš„æ—§èŠ‚ç‚¹çš„ç´¢å¼•å°äºä¹‹å‰æ‰¾åˆ°çš„ æœ€ç´¢å¼•å€¼
            // éœ€è¦ç§»åŠ¨
          } else {
            lastIndex = j;
          }
          break;
        }
      }
    }
  } else {
  }
}
```

ç§»åŠ¨æŒ‡çš„ç§»åŠ¨çœŸå®domï¼Œä¸æ˜¯ç§»åŠ¨è™šæ‹ŸèŠ‚ç‚¹ã€‚æ—¢ç„¶ç§»åŠ¨domï¼Œå¿…é¡»å–åˆ°å®ƒçš„å¼•ç”¨ã€‚ä¸€ä¸ªè™šæ‹ŸèŠ‚ç‚¹è¢«æŒ‚è½½åï¼Œä¸å…¶å¯¹åº”çš„çœŸå®domä¼šå­˜å‚¨åœ¨ vnode.el å±æ€§é‡Œã€‚

å½“è°ƒç”¨æ›´æ–°é€»è¾‘æ—¶å€™ï¼Œæ¸²æŸ“å™¨ä¼šè°ƒç”¨ patchElement å‡½æ•°åœ¨æ–°æ—§èŠ‚ç‚¹ä¹‹å‰æ‰“è¡¥ä¸ã€‚

```JavaScript
function patchElement(n1, n2) {
  // ...
  // dom å…ƒç´ å¤ç”¨åï¼Œæ–°èŠ‚ç‚¹å°±æœ‰äº†å¯¹çœŸå®dom çš„å¼•ç”¨
  const el = n2.el = n1.el
  // ...
}
```
![](Pasted%20image%2020220314172718.png)

p-1 å¯¹åº”çš„çœŸå®doméœ€è¦ç§»åŠ¨åˆ°p-3å¯¹åº”çš„çœŸå®domçš„åé¢ï¼Œæ­¤æ—¶domçš„é¡ºåºå˜æˆ p-2, p-3, p-1ã€‚

p-2 å¯¹åº”çš„çœŸå®doméœ€è¦ç§»åŠ¨åˆ°p-3å¯¹åº”çš„çœŸå®domçš„åé¢ï¼Œä¹Ÿåœ¨p-1å¯¹åº”çš„çœŸå®domåé¢ï¼Œæ­¤æ—¶domçš„é¡ºåºå˜æˆp-3, p-1, p-2æ›´æ–°å®Œæˆã€‚

![](Pasted%20image%2020220314174926.png)

```js

function patch(n1, n2, container) {
  if (n2.children === "string") {
  } else if (Array.isArray(n2.children)) {
    const oldChildren = n1.children;
    const newChildren = n2.children;

    const oldLen = oldChildren.length;
    const newLen = newChildren.length;
    const lastIndex = 0;
    for (let i = 0; i < newLen; i++) {
      const newVNode = newChildren[i];
      for (let j = 0; j < oldLen; j++) {
        const oldVNode = oldChildren[j];

        if (newVNode.key === oldVNode.key) {
          patch(oldVNode, newVNode);
          if (lastIndex > j) {
            // å½“å‰çš„æ–°èŠ‚ç‚¹æ‰¾åˆ°çš„å¯¹åº”çš„æ—§èŠ‚ç‚¹çš„ç´¢å¼•å°äºä¹‹å‰æ‰¾åˆ°çš„ æœ€ç´¢å¼•å€¼
            // éœ€è¦ç§»åŠ¨

            // ä¸Šä¸€ä¸ªèŠ‚ç‚¹
            const prevVNode = newChildren[i - 1];
            if (prevVNode) {
              // å°† newVNode å¯¹åº”çš„domç§»åŠ¨åˆ° prevVNode å¯¹åº”çš„domçš„åé¢
              // æ‰€ä»¥æˆ‘ä»¬è¦è·å– prevVNode å¯¹åº”domçš„ä¸‹ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹ï¼Œå°†å…¶ä½œä¸ºé”šç‚¹
              const anchor = prevVNode.el.nextSibling;

              // è°ƒç”¨insert å°† newVNode å¯¹åº”çš„dom æ’å…¥åˆ°é”šç‚¹çš„å‰é¢ï¼Œä¹Ÿå°±æ˜¯prevVnodeå¯¹åº”domçš„åé¢
              insert(newVNode.el, container, anchor);
            } else {
              // å¦‚æœ prevVNode ä¸å­˜åœ¨ï¼Œè¯´æ˜å½“å‰ newVNode æ˜¯ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¸éœ€è¦ç§»åŠ¨
            }
          } else {
            lastIndex = j;
          }
          break;
        }
      }
    }
  } else {
  }
}
```
insert å‡½æ•°ä¾èµ–æµè§ˆå™¨åŸç”Ÿçš„ insertBefore å‡½æ•°

```JavaScript
const renderer = createRenderer({
  // ...
  insert(el, parent, anchor = null) {
    parent.insertBefore(el, anchor);
  },
  // ...
});

```