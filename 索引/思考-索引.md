# ç»„ä»¶å®ç°åŸç†ç›¸å…³å†…å®¹
#### ä¸€ä¸ªæœ‰çŠ¶æ€çš„ç»„ä»¶å°±æ˜¯ä¸€ä¸ªé€‰é¡¹å¯¹è±¡
```js
const MyComponent = {
  name: 'MyComponent',
  data() {
    return {
      foo: 1
    }
  }
}
```
#### ç”¨è™šæ‹ŸèŠ‚ç‚¹æè¿°ç»„ä»¶
```js
// type å±æ€§å­˜å‚¨ç»„ä»¶çš„é€‰é¡¹å¯¹è±¡
const vnode = {
  type: MyComponent,
  // ...
}
```
#### ä¸€ä¸ªç»„ä»¶å¿…é¡»åŒ…å«ä¸€ä¸ªæ¸²æŸ“å‡½æ•°ï¼Œå³ render å‡½æ•°ï¼Œå¹¶ä¸”è¿”å›å€¼æ˜¯è™šæ‹Ÿ domã€‚
```js
const MyComponent = {
  name: "MyComponent",
  render() {
    return {
      type: "div",
      children: "text",
    };
  },
};
```
#### effect æ‰§è¡Œæ˜¯åŒæ­¥çš„ï¼Œå¤šæ¬¡ä¿®æ”¹å“åº”å¼æ•°æ®ï¼Œä¼šé¢‘ç¹æ›´æ–°ï¼Œé€ æˆæ€§èƒ½å¼€é”€å¤§ã€‚è§£å†³æ–¹æ¡ˆï¼šå½“å‰¯ä½œç”¨å‡½æ•°éœ€è¦é‡æ–°æ‰§è¡Œæ—¶ï¼Œæˆ‘ä»¬ä¸ç«‹åˆ»æ‰§è¡Œï¼Œè€Œæ˜¯å°†ä»–æ”¾å…¥ä¸€ä¸ªå¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œç­‰æ‰§è¡Œæ ˆæ¸…ç©ºåï¼Œå†å°†ä»–ä»å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­å–å‡ºæ¥å¹¶æ‰§è¡Œã€‚
æœ€å°å®ç°
```js
const queue = new Set();
let isFlushing = false;
const p = Promise.resolve;
function queueJob(job) {
  queue.add(job);
  if (isFlushing) {
    isFlushing = true;
    p.then(() => {
      try {
        queue.forEach((job) => job());
      } finally {
        isFlushing = false;
        queue.length = 0;
      }
    });
  }
}
```
```js
instance.update = effect(() => {
  // ...
}, {
  scheduler: queueJob(instance.update);
});
```
#### ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸ
ç›´æ¥ä¸Šé€»è¾‘ç 
```js
function cmountComponent() {
  // ...
  beforeCreate && beforeCreate();
  const instance = {};
  vnode.component = instance;

  created && created.call(state);

  instance.updated = effect(
    () => {
      const subTree = instance.render.call(state);
      if (!isMounted) {
        baforeMounted && baforeMounted.call(state);
        patch(null, subTree);
        mounted && mounted.call(state);
        // ...
      } else {
        beforeUpdate && beforeUpdate.call(state);
        patch(prevSubTree, subTree);
        updated && updated.call(state);
      }
    },
    {
      scheduler: queueJob(instance.updated),
    }
  );
}
```

#### setup å‡½æ•°
1. è¿”å›ä¸€ä¸ªå‡½æ•°çš„è¯ï¼Œä½œä¸º render å‡½æ•°
2. è¿”å›ä¸€ä¸ªå¯¹è±¡çš„è¯ï¼Œç»™å¯¹è±¡æš´éœ²ç»™æ¨¡æ¿ä½¿ç”¨ï¼Œä¹Ÿå°±æ˜¯èƒ½ç”¨this è®¿é—®
##### ç»„ä»¶åˆå§‹åŒ–é˜¶æ®µï¼Œåˆ†åˆ«åˆå§‹åŒ– props slots å’Œ ç»„ä»¶çŠ¶æ€ã€‚
#### ç»„ä»¶çŠ¶æ€å°±æ˜¯ setup() çš„ç»“æœè¦æŒ‚åœ¨ ç»„ä»¶å®ä¾‹ä¸Šï¼Œé€»è¾‘å¦‚ä¸‹

1. æä¸€ä¸ªç»„ä»¶å®ä¾‹çš„ä»£ç†å¯¹è±¡,åªæœ‰ `get` æ“ä½œ
```js
instance.proxy = new Proxy(
  {},
  {
    get(target, key) {
      // setupState çš„è·å–æ–¹æ³•åœ¨ ä¸‹é¢
      const { setupState, props } = instance;
      // å½“ this.xxxï¼Œå¦‚æœxxx æ˜¯setup() çš„è¿”å›å¯¹è±¡çš„ key æ—¶
      if (key in setupState) {
        return setupState[key];
      }
      // key åœ¨ props é‡Œé¢
      if (key in props) {
        return props[key];
      }
      if (key === "$el") {
        // è¿™æ˜¯ç»„ä»¶å®ä¾‹çš„è™šæ‹ŸèŠ‚ç‚¹
        return instance.vnode.el;
      }
      if (key === "$props") {
        // è¿™æ˜¯ç»„ä»¶å®ä¾‹çš„props,å¾ˆå°‘ç”¨
        return instance.vnode.props;
      }
    },
  }
);
```
2. ä»€ä¹ˆæ—¶å€™ç”¨ è¿™ä¸ª ä»£ç†å¯¹è±¡
åœ¨ç»„ä»¶å®ä¾‹è°ƒç”¨`render`å‡½æ•°è¿”å› ç»„ä»¶èŠ‚ç‚¹æ ‘ subTree æ—¶æœºç”¨ã€‚ä¹Ÿå°±æ˜¯ç»„ä»¶åˆå§‹åŒ–å®Œæˆçš„ä¸‹ä¸€ä¸ªæ“ä½œï¼Œå¦‚ä¸‹ä»£ç 
```js
function setupRenderEffect(
  instance: any,
  initialVNode: any,
  container,
  anchor
) {
  instance.update = effect(
    () => {
      if (!instance.isMounted) {
        const { proxy } = instance;
        const subTree = (instance.subTree = instance.render.call(proxy));
        // ...
      } else {
        // ...
        const { proxy } = instance;
        const subTree = instance.render.call(proxy);
      }
    },
    {
      scheduler() {
        queueJobs(instance.update);
      },
    }
  );
}
```
3. è¿™æ ·å°±å¯ä»¥é€šè¿‡ï¼Œthis.xxx è·å– props å’Œ setup è¿”å›å¯¹è±¡ï¼Œä»¥åŠ $el ç­‰ç­‰çš„å€¼äº† ğŸ‘±â€â™€
4. å–åˆ°setup å‡½æ•°ï¼Œå¹¶è°ƒç”¨ï¼Œæ‹¿åˆ° setupState åï¼ŒæŒ‚è½½åˆ° instance ä¸Š, ç»™ä¸Šé¢æåˆ°çš„ `ä»£ç†å¯¹è±¡ instance.proxy` ä½¿ç”¨

```js
const { setup } = instance.type;
if (setup) {
  // props shallow readonly
  const setupResult = setup(shallowReadonly(instance.props), {
    emit: instance.emit,
  });
  if (typeof setupResult === "object") {
    instance.setupState = proxyRef(setupResult);
  }
  instance.render = instance.type.render;
}
```